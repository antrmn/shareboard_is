<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shareboard_is</a> &gt; <a href="index.source.html" class="el_package">model.repository</a> &gt; <span class="el_source">PostRepository.java</span></div><h1>PostRepository.java</h1><pre class="source lang-java linenums">package model.repository;

import model.entity.Post;
import model.entity.Section;
import model.entity.User;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.*;
import java.io.Serializable;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

/**
 * Classe che incapsula la logica per il recupero di entità di tipo {@link Post}
 */
<span class="fc" id="L20">public class PostRepository implements Serializable {</span>

    @PersistenceContext
    protected EntityManager em;

    /**
     * Restituisce una nuova istanza di PostFinder
     * @return nuova istanza di PostFinder
     */
    public PostFinder getFinder(){
<span class="fc" id="L30">        return new PostFinder();</span>
    }

<span class="fc" id="L33">    private enum SortCriteria {OLDEST, NEWEST, MOSTVOTED};</span>

    /**
     *  Classe interna usata per specificare i parametri di ricerca di un post
     */
    public class PostFinder {
        private User author;
        private List&lt;Section&gt; sections;
        private Instant before;
        private Instant after;
<span class="fc" id="L43">        private int offset = 0;</span>
<span class="fc" id="L44">        private int pageSize = 30;</span>
        private String content;
<span class="fc" id="L46">        private boolean includeBody = false;</span>
        private User joinUserFollows;
<span class="fc" id="L48">        private SortCriteria sortCriteria = PostRepository.SortCriteria.NEWEST;</span>

<span class="fc" id="L50">        protected PostFinder(){ }</span>

        /**
         * Setta il campo author e restituisce l'istanza passata di PostFinder
         * @param author entità User dell'autore dei post
         * @return istanza passata di PostFinder
         */
        public PostFinder byAuthor(User author){
<span class="fc" id="L58">            this.author = author;</span>
<span class="fc" id="L59">            return this;</span>
        }

        /**
         * Setta il campo content e restituisce l'istanza passata di PostFinder
         * @param author text contenuto dei post
         * @return istanza passata di PostFinder
         */
        public PostFinder byContent(String text){
<span class="fc" id="L68">            this.content = text;</span>
<span class="fc" id="L69">            return this;</span>
        }

        /**
         * Setta il campo sections e restituisce l'istanza passata di PostFinder
         * @param sections lista di sezioni
         * @return istanza passata di PostFinder
         */
        public PostFinder bySections(List&lt;Section&gt; sections){
<span class="fc" id="L78">            this.sections = sections;</span>
<span class="fc" id="L79">            return this;</span>
        }

        /**
         * Setta il campo sections e restituisce l'istanza passata di PostFinder
         * @param sections sezione dei post
         * @return istanza passata di PostFinder
         */
        public PostFinder bySection(Section section){
<span class="fc" id="L88">            this.sections = Collections.singletonList(section);</span>
<span class="fc" id="L89">            return this;</span>
        }

        /**
         * Setta il campo postedAfter e restituisce l'istanza passata di PostFinder
         * @param after data dopo la quale i post da trovare sono stati postati
         * @return istanza passata di PostFinder
         */
        public PostFinder postedAfter(Instant after){
<span class="fc" id="L98">            this.after = after;</span>
<span class="fc" id="L99">            return this;</span>
        }

        /**
         * Setta il campo postedBefore e restituisce l'istanza passata di PostFinder
         * @param before data prima della quale i post da trovare sono stati postati
         * @return istanza passata di PostFinder
         */
        public PostFinder postedBefore(Instant before){
<span class="fc" id="L108">            this.before = before;</span>
<span class="fc" id="L109">            return this;</span>
        }

        /**
         * Setta il campo offset e restituisce l'istanza passata di PostFinder
         * @param n offset per la paginazione
         * @return istanza passata di PostFinder
         */
        public PostFinder offset(int n){
<span class="fc" id="L118">            offset = n;</span>
<span class="fc" id="L119">            return this;</span>
        }

        /**
         * Setta il campo limit e restituisce l'istanza passata di PostFinder
         * @param n limite di post da caricare
         * @return istanza passata di PostFinder
         */
        public PostFinder limit(int n){
<span class="fc" id="L128">            pageSize = n;</span>
<span class="fc" id="L129">            return this;</span>
        }

        /**
         * Setta il campo sortCriteria a oldest e restituisce l'istanza passata di PostFinder
         * @return istanza passata di PostFinder
         */
        public PostFinder getOldest(){
<span class="fc" id="L137">            sortCriteria = SortCriteria.OLDEST;</span>
<span class="fc" id="L138">            return this;</span>
        }

        /**
         * Setta il campo sortCriteria a newest e restituisce l'istanza passata di PostFinder
         * @return istanza passata di PostFinder
         */
        public PostFinder getNewest(){
<span class="fc" id="L146">            sortCriteria = SortCriteria.NEWEST;</span>
<span class="fc" id="L147">            return this;</span>
        }

        /**
         * Setta il campo sortCriteria a most voted e restituisce l'istanza passata di PostFinder
         * @return istanza passata di PostFinder
         */
        public PostFinder getMostVoted(){
<span class="fc" id="L155">            sortCriteria = SortCriteria.MOSTVOTED;</span>
<span class="fc" id="L156">            return this;</span>
        }

        /**
         * Setta il campo includeBody a true e restituisce l'istanza passata di PostFinder
         * @return istanza passata di PostFinder
         */
        public PostFinder includeBody(){
<span class="fc" id="L164">            includeBody = true;</span>
<span class="fc" id="L165">            return this;</span>
        }

        /**
         * Setta il campo joinUserFollows e restituisce l'istanza passata di PostFinder
         * @param user entita utente da cui ottenere le sezioni seguite
         * @return istanza passata di PostFinder
         */
        public PostFinder joinUserFollows(User user){
<span class="fc" id="L174">            joinUserFollows = user;</span>
<span class="fc" id="L175">            return this;</span>
        }

        /**
         * Restituisce tutti i post che rispettano i criteri di ricerca
         * @return lista di entità Post
         */
        public List&lt;Post&gt; getResults(){
<span class="fc" id="L183">            CriteriaBuilder cb = em.getCriteriaBuilder();</span>
<span class="fc" id="L184">            CriteriaQuery&lt;Post&gt; cq = cb.createQuery(Post.class);</span>
<span class="fc" id="L185">            Root&lt;Post&gt; root = cq.from(Post.class);</span>

<span class="fc" id="L187">            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L189" title="All 2 branches covered.">            if(author != null) {</span>
<span class="fc" id="L190">                predicates.add(cb.equal(root.get(&quot;author&quot;), author));</span>
            }

<span class="pc bpc" id="L193" title="1 of 4 branches missed.">            if(sections != null &amp;&amp; !sections.isEmpty()) {</span>
<span class="fc" id="L194">                predicates.add(root.get(&quot;section&quot;).in(sections));</span>
            }

<span class="fc bfc" id="L197" title="All 2 branches covered.">            if(after != null) {</span>
<span class="fc" id="L198">                predicates.add(cb.greaterThanOrEqualTo(root.get(&quot;creationDate&quot;), after));</span>
            }

<span class="fc bfc" id="L201" title="All 2 branches covered.">            if(before != null) {</span>
<span class="fc" id="L202">                predicates.add(cb.lessThanOrEqualTo(root.get(&quot;creationDate&quot;), before));</span>
            }

<span class="fc bfc" id="L205" title="All 2 branches covered.">            if(content != null) {</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">                if(includeBody) {</span>
<span class="fc" id="L207">                    predicates.add(</span>
<span class="fc" id="L208">                            cb.or(</span>
<span class="fc" id="L209">                                    cb.like(root.get(&quot;title&quot;), '%' + content + '%'),</span>
<span class="fc" id="L210">                                    cb.and(</span>
<span class="fc" id="L211">                                            cb.notEqual(root.get(&quot;type&quot;), Post.Type.IMG),</span>
<span class="fc" id="L212">                                            cb.like(root.get(&quot;content&quot;), '%' + content + '%')</span>
                                    )));
                } else {
<span class="fc" id="L215">                    predicates.add(cb.like(root.get(&quot;title&quot;), '%' + content + '%'));</span>
                }
            }

<span class="fc bfc" id="L219" title="All 2 branches covered.">            if(joinUserFollows != null){</span>
<span class="fc" id="L220">                Join&lt;Object, Object&gt; joinFollow = root.join(&quot;section&quot;).join(&quot;follows&quot;);</span>
<span class="fc" id="L221">                predicates.add(cb.equal(joinFollow.get(&quot;user&quot;), joinUserFollows));</span>
            }

<span class="fc" id="L224">            cq.where(cb.and(predicates.toArray(Predicate[]::new)));</span>

<span class="fc bfc" id="L226" title="All 3 branches covered.">            switch (sortCriteria) {</span>
                case MOSTVOTED:
<span class="fc" id="L228">                    cq.orderBy(cb.desc(root.get(&quot;votesCount&quot;)));</span>
<span class="fc" id="L229">                    break;</span>
                case OLDEST:
<span class="fc" id="L231">                    cq.orderBy(cb.asc(root.get(&quot;creationDate&quot;)));</span>
<span class="fc" id="L232">                    break;</span>
                case NEWEST:
                default:
<span class="fc" id="L235">                    cq.orderBy(cb.desc(root.get(&quot;creationDate&quot;)));</span>
                    break;
            }


<span class="fc" id="L240">            TypedQuery&lt;Post&gt; tq = em.createQuery(cq);</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">            if(offset &gt;= 0)</span>
<span class="fc" id="L242">                tq.setFirstResult(offset);</span>
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">            if(pageSize&gt;=0)</span>
<span class="fc" id="L244">                tq.setMaxResults(pageSize);</span>

<span class="fc" id="L246">            return tq.getResultList();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>