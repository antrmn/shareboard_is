<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shareboard_is</a> &gt; <a href="index.source.html" class="el_package">persistence.repo</a> &gt; <span class="el_source">PostRepository.java</span></div><h1>PostRepository.java</h1><pre class="source lang-java linenums">package persistence.repo;

import persistence.model.Post;
import persistence.model.Section;
import persistence.model.User;

import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import javax.persistence.criteria.*;
import java.io.Serializable;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

<span class="fc" id="L17">public class PostRepository implements Serializable {</span>

    @PersistenceContext
    protected EntityManager em;

    public PostFinder getFinder(){
<span class="fc" id="L23">        return new PostFinder();</span>
    }

<span class="fc" id="L26">    private enum SortCriteria {OLDEST, NEWEST, MOSTVOTED};</span>
    public class PostFinder {
        private User author;
        private List&lt;Section&gt; sections;
        private Instant before;
        private Instant after;
<span class="fc" id="L32">        private int offset = 0;</span>
<span class="fc" id="L33">        private int pageSize = 30;</span>
        private String content;
<span class="fc" id="L35">        private boolean includeBody = false;</span>
        private User joinUserFollows;
<span class="fc" id="L37">        private SortCriteria sortCriteria = PostRepository.SortCriteria.NEWEST;</span>

<span class="fc" id="L39">        protected PostFinder(){ }</span>

        public PostFinder byAuthor(User author){
<span class="fc" id="L42">            this.author = author;</span>
<span class="fc" id="L43">            return this;</span>
        }

        public PostFinder byContent(String text){
<span class="fc" id="L47">            this.content = text;</span>
<span class="fc" id="L48">            return this;</span>
        }

        public PostFinder bySections(List&lt;Section&gt; sections){
<span class="fc" id="L52">            this.sections = sections;</span>
<span class="fc" id="L53">            return this;</span>
        }

        public PostFinder bySection(Section section){
<span class="fc" id="L57">            this.sections = Collections.singletonList(section);</span>
<span class="fc" id="L58">            return this;</span>
        }

        public PostFinder postedAfter(Instant after){
<span class="fc" id="L62">            this.after = after;</span>
<span class="fc" id="L63">            return this;</span>
        }

        public PostFinder postedBefore(Instant before){
<span class="fc" id="L67">            this.before = before;</span>
<span class="fc" id="L68">            return this;</span>
        }

        public PostFinder offset(int n){
<span class="fc" id="L72">            offset = n;</span>
<span class="fc" id="L73">            return this;</span>
        }

        public PostFinder limit(int n){
<span class="fc" id="L77">            pageSize = n;</span>
<span class="fc" id="L78">            return this;</span>
        }

        public PostFinder getOldest(){
<span class="fc" id="L82">            sortCriteria = SortCriteria.OLDEST;</span>
<span class="fc" id="L83">            return this;</span>
        }

        public PostFinder getNewest(){
<span class="fc" id="L87">            sortCriteria = SortCriteria.NEWEST;</span>
<span class="fc" id="L88">            return this;</span>
        }

        public PostFinder getMostVoted(){
<span class="fc" id="L92">            sortCriteria = SortCriteria.MOSTVOTED;</span>
<span class="fc" id="L93">            return this;</span>
        }

        public PostFinder includeBody(){
<span class="fc" id="L97">            includeBody = true;</span>
<span class="fc" id="L98">            return this;</span>
        }

        public PostFinder joinUserFollows(User user){
<span class="fc" id="L102">            joinUserFollows = user;</span>
<span class="fc" id="L103">            return this;</span>
        }

        public List&lt;Post&gt; getResults(){
<span class="fc" id="L107">            CriteriaBuilder cb = em.getCriteriaBuilder();</span>
<span class="fc" id="L108">            CriteriaQuery&lt;Post&gt; cq = cb.createQuery(Post.class);</span>
<span class="fc" id="L109">            Root&lt;Post&gt; root = cq.from(Post.class);</span>

<span class="fc" id="L111">            List&lt;Predicate&gt; predicates = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">            if(author != null) {</span>
<span class="fc" id="L114">                predicates.add(cb.equal(root.get(&quot;author&quot;), author));</span>
            }

<span class="pc bpc" id="L117" title="1 of 4 branches missed.">            if(sections != null &amp;&amp; !sections.isEmpty()) {</span>
<span class="fc" id="L118">                predicates.add(root.get(&quot;section&quot;).in(sections));</span>
            }

<span class="fc bfc" id="L121" title="All 2 branches covered.">            if(after != null) {</span>
<span class="fc" id="L122">                predicates.add(cb.greaterThanOrEqualTo(root.get(&quot;creationDate&quot;), after));</span>
            }

<span class="fc bfc" id="L125" title="All 2 branches covered.">            if(before != null) {</span>
<span class="fc" id="L126">                predicates.add(cb.lessThanOrEqualTo(root.get(&quot;creationDate&quot;), before));</span>
            }

<span class="fc bfc" id="L129" title="All 2 branches covered.">            if(content != null) {</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">                if(includeBody) {</span>
<span class="fc" id="L131">                    predicates.add(</span>
<span class="fc" id="L132">                            cb.or(</span>
<span class="fc" id="L133">                                    cb.like(root.get(&quot;title&quot;), '%' + content + '%'),</span>
<span class="fc" id="L134">                                    cb.and(</span>
<span class="fc" id="L135">                                            cb.notEqual(root.get(&quot;type&quot;), Post.Type.IMG),</span>
<span class="fc" id="L136">                                            cb.like(root.get(&quot;content&quot;), '%' + content + '%')</span>
                                    )));
                } else {
<span class="fc" id="L139">                    predicates.add(cb.like(root.get(&quot;title&quot;), '%' + content + '%'));</span>
                }
            }

<span class="fc bfc" id="L143" title="All 2 branches covered.">            if(joinUserFollows != null){</span>
<span class="fc" id="L144">                Join&lt;Object, Object&gt; joinFollow = root.join(&quot;section&quot;).join(&quot;follows&quot;);</span>
<span class="fc" id="L145">                predicates.add(cb.equal(joinFollow.get(&quot;user&quot;), joinUserFollows));</span>
            }

<span class="fc" id="L148">            cq.where(cb.and(predicates.toArray(Predicate[]::new)));</span>

<span class="fc bfc" id="L150" title="All 3 branches covered.">            switch (sortCriteria) {</span>
                case MOSTVOTED:
<span class="fc" id="L152">                    cq.orderBy(cb.desc(root.get(&quot;votesCount&quot;)));</span>
<span class="fc" id="L153">                    break;</span>
                case OLDEST:
<span class="fc" id="L155">                    cq.orderBy(cb.asc(root.get(&quot;creationDate&quot;)));</span>
<span class="fc" id="L156">                    break;</span>
                case NEWEST:
                default:
<span class="fc" id="L159">                    cq.orderBy(cb.desc(root.get(&quot;creationDate&quot;)));</span>
                    break;
            }


<span class="fc" id="L164">            TypedQuery&lt;Post&gt; tq = em.createQuery(cq);</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">            if(offset &gt;= 0)</span>
<span class="fc" id="L166">                tq.setFirstResult(offset);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            if(pageSize&gt;=0)</span>
<span class="fc" id="L168">                tq.setMaxResults(pageSize);</span>

<span class="fc" id="L170">            return tq.getResultList();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>