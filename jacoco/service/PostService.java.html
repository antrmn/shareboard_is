<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PostService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">shareboard_is</a> &gt; <a href="index.source.html" class="el_package">service</a> &gt; <span class="el_source">PostService.java</span></div><h1>PostService.java</h1><pre class="source lang-java linenums">package service;

import persistence.model.Post;
import persistence.model.Section;
import persistence.model.User;
import persistence.repo.BinaryContentRepository;
import persistence.repo.GenericRepository;
import persistence.repo.PostRepository;
import service.auth.AuthenticationRequired;
import service.auth.AuthorizationException;
import service.auth.DenyBannedUsers;
import service.dto.CurrentUser;
import service.dto.PostPage;
import service.dto.PostSearchForm;
import service.dto.PostType;
import service.validation.Image;
import service.validation.PostExists;
import service.validation.SectionExists;
import util.ReadLimitExceededException;

import javax.enterprise.context.ApplicationScoped;
import javax.inject.Inject;
import javax.transaction.Transactional;
import javax.validation.constraints.NotBlank;
import javax.validation.constraints.NotNull;
import javax.validation.constraints.Size;
import java.io.BufferedInputStream;
import java.io.IOException;
import java.time.Instant;
import java.util.List;
import java.util.stream.Collectors;

import static persistence.model.Post.Type.IMG;
import static persistence.model.Post.Type.TEXT;
import static service.dto.PostSearchForm.SortCriteria.NEWEST;


@ApplicationScoped
@Transactional
public class PostService {
    private GenericRepository genericRepository;
    private PostRepository postRepo;
    private BinaryContentRepository bcRepo;
    private CurrentUser currentUser;

<span class="nc" id="L46">    protected PostService(){}</span>

    @Inject
    protected PostService(GenericRepository genericRepository, PostRepository postRepo,
<span class="fc" id="L50">                          BinaryContentRepository bcRepo, CurrentUser currentUser){</span>
<span class="fc" id="L51">        this.genericRepository = genericRepository;</span>
<span class="fc" id="L52">        this.postRepo = postRepo;</span>
<span class="fc" id="L53">        this.bcRepo = bcRepo;</span>
<span class="fc" id="L54">        this.currentUser = currentUser;</span>
<span class="fc" id="L55">    }</span>

    /**
     * Converte post in PostPage.
     * @param post post da convertire
     * @return PostPage con i dati di post
     */
    private PostPage mapPost(Post post){
<span class="fc" id="L63">        User user = null;</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if(currentUser.isLoggedIn())</span>
<span class="fc" id="L65">            user = genericRepository.findById(User.class,currentUser.getId());</span>

        //converte persistence.Post.Type in service.dto.PostType (ew)
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        PostType postType = post.getType() == IMG ? PostType.IMG : PostType.TEXT;</span>

<span class="fc" id="L70">        return PostPage.builder()</span>
<span class="fc" id="L71">                .id(post.getId())</span>
<span class="fc" id="L72">                .title(post.getTitle())</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">                .vote(post.getVote(user) == null ? 0 : post.getVote(user).getVote())</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">                .votes(post.getVotesCount() == null ? 0 : post.getVotesCount())</span>
<span class="fc" id="L75">                .sectionName(post.getSection().getName())</span>
<span class="fc" id="L76">                .authorName(post.getAuthor().getUsername())</span>
<span class="fc" id="L77">                .sectionId(post.getSection().getId())</span>
<span class="fc" id="L78">                .authorId(post.getAuthor().getId())</span>
<span class="fc" id="L79">                .content(post.getContent())</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                .creationDate(post.getCreationDate() == null ? Instant.now() : post.getCreationDate())</span>
<span class="fc" id="L81">                .nComments(post.getCommentCount())</span>
<span class="fc" id="L82">                .type(postType)</span>
<span class="fc" id="L83">                .build();</span>
    }

    /**
     * Ritorna un entità DTO relativa ad un post
     * @param id identificativo post
     * @return DTO di un post
     */
    public PostPage getPost(@PostExists int id){
<span class="fc" id="L92">        Post p = genericRepository.findById(Post.class,id);</span>
<span class="fc" id="L93">        return mapPost(p);</span>
    }

    /**
     * Ritorna una lista di post che rispettano determinati parametri
     * @param form entità con i parametri di ricerca
     * @return lista di PostPage
     */
    @Transactional
    public List&lt;PostPage&gt; loadPosts(PostSearchForm form){
<span class="fc" id="L103">        final int elementsPerPage = 10;</span>
<span class="fc" id="L104">        PostRepository.PostFinder finder = postRepo.getFinder();</span>

<span class="fc" id="L106">        finder.limit(elementsPerPage);</span>

<span class="pc bpc" id="L108" title="1 of 2 branches missed.">        int page = form.getPage() &gt; 0 ? form.getPage() : 1;</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        finder.offset((page == 1) ? 0 : (page-1) * elementsPerPage+1);</span>

<span class="pc bpc" id="L111" title="1 of 2 branches missed.">        if(form.getContent() != null) {</span>
<span class="fc" id="L112">            finder.byContent(form.getContent());</span>
        }
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if(form.isIncludeBody()){</span>
<span class="fc" id="L115">            finder.includeBody();</span>
        }
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if(form.getSectionName() != null){</span>
<span class="fc" id="L118">            Section section = genericRepository.findByNaturalId(Section.class, form.getSectionName());</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">            if(section != null){</span>
<span class="fc" id="L120">                finder.bySection(section);</span>
            }
        }
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        if(form.getAuthorName() != null){</span>
<span class="fc" id="L124">            User user = genericRepository.findByNaturalId(User.class, form.getAuthorName());</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">            if(user != null){</span>
<span class="fc" id="L126">                finder.byAuthor(user);</span>
            }
        }
<span class="pc bpc" id="L129" title="2 of 4 branches missed.">        if(form.isOnlyFollow() &amp;&amp; currentUser.isLoggedIn()){</span>
<span class="fc" id="L130">            finder.joinUserFollows(genericRepository.findById(User.class,currentUser.getId()));</span>
        }
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        if(form.getPostedAfter() != null){</span>
<span class="fc" id="L133">            finder.postedAfter(form.getPostedAfter());</span>
        }
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if(form.getPostedBefore() != null){</span>
<span class="fc" id="L136">            finder.postedBefore(form.getPostedBefore());</span>
        }

        //null-safe switch
<span class="pc bpc" id="L140" title="1 of 5 branches missed.">        switch(form.getOrderBy() != null ? form.getOrderBy() : NEWEST){</span>
            case NEWEST: default: {
<span class="fc" id="L142">                finder.getNewest();</span>
<span class="fc" id="L143">                break;</span>
            }
            case OLDEST:{
<span class="fc" id="L146">                finder.getOldest();</span>
<span class="fc" id="L147">                break;</span>
            }
            case MOSTVOTED:{
<span class="fc" id="L150">                finder.getMostVoted();</span>
                break;
            }
        }
<span class="fc" id="L154">        return finder.getResults().stream().map(this::mapPost).collect(Collectors.toList());</span>
    }

    /**
     * Elimina un post dato il suo id
     * @param id identificativo del post
     */
    @AuthenticationRequired //TODO: check autore post?
    @DenyBannedUsers
    public void delete(@PostExists int id){
<span class="fc" id="L164">        Post post = genericRepository.findById(Post.class,id);</span>
<span class="fc bfc" id="L165" title="All 4 branches covered.">        if(currentUser.getId() != post.getAuthor().getId() &amp;&amp; !currentUser.isAdmin())</span>
<span class="fc" id="L166">            throw new AuthorizationException();</span>
<span class="fc" id="L167">        genericRepository.remove(genericRepository.findById(User.class,id));</span>
<span class="fc" id="L168">    }</span>

    /**
     * Aggiunge un post ad una sezione
     * @param title titolo del post
     * @param body testo del post
     * @param sectionName nome della sezione
     * @return identificativo del nuovo post creato
     */
    @AuthenticationRequired
    @DenyBannedUsers
    public int newPost(@NotBlank String title,
                       @Size(max=65535) String body,
                       @NotNull @SectionExists String sectionName){
<span class="fc" id="L182">        User user = genericRepository.findByNaturalId(User.class, currentUser.getUsername());</span>
<span class="fc" id="L183">        Section section = genericRepository.findByNaturalId(Section.class,sectionName);</span>


<span class="fc" id="L186">        Post post = new Post();</span>
<span class="fc" id="L187">        post.setTitle(title);</span>
<span class="pc bpc" id="L188" title="2 of 4 branches missed.">        post.setContent(body == null || body.isBlank() ? &quot;&quot; : body);</span>
<span class="fc" id="L189">        post.setAuthor(user);</span>
<span class="fc" id="L190">        post.setSection(section);</span>
<span class="fc" id="L191">        post.setType(TEXT);</span>

<span class="fc" id="L193">        return genericRepository.insert(post).getId();</span>
    }

    /**
     * Aggiunge un post ad una sezione
     * @param title titolo del post
     * @param content file di tipo immagine
     * @param sectionName nome della sezione
     * @return identificativo del nuovo post creato
     */
    @AuthenticationRequired
    @DenyBannedUsers
    public int newPost(@NotBlank @Size(max=255) String title,
                       @NotNull @Image BufferedInputStream content,
                       @NotNull @SectionExists String sectionName){
<span class="fc" id="L208">        User user = genericRepository.findByNaturalId(User.class,currentUser.getUsername());</span>
<span class="fc" id="L209">        Section section = genericRepository.findByNaturalId(Section.class,sectionName);</span>

        String fileName;
        try {
<span class="fc" id="L213">            fileName = bcRepo.insert(content);</span>
<span class="nc" id="L214">        } catch (ReadLimitExceededException e){</span>
<span class="nc" id="L215">            throw new IllegalArgumentException(&quot;Il file non deve superare i 5MB&quot;);</span>
<span class="nc" id="L216">        } catch (IOException e) {</span>
<span class="nc" id="L217">            throw new RuntimeException(e);</span>
<span class="fc" id="L218">        }</span>

<span class="fc" id="L220">        Post post = new Post();</span>
<span class="fc" id="L221">        post.setTitle(title);</span>
<span class="fc" id="L222">        post.setAuthor(user);</span>
<span class="fc" id="L223">        post.setContent(fileName);</span>
<span class="fc" id="L224">        post.setSection(section);</span>
<span class="fc" id="L225">        post.setType(IMG);</span>

<span class="fc" id="L227">        return genericRepository.insert(post).getId(); //in caso di errore il file resta</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>